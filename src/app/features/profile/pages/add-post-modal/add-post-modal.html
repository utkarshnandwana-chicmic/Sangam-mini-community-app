<div class="modal-backdrop" (click)="close.emit()"></div>

<div class="modal-container" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>{{ editMode ? 'Edit Post' : 'Create New Post' }}</h3>
    <button class="close-icon-btn" (click)="close.emit()">âœ•</button>
  </div>

  <form [formGroup]="form" class="modal-body">
    <div class="form-scroll-container">

      <!-- =========================
           MEDIA SECTION
      ========================= -->

      <div class="upload-zone" [class.has-media]="previewUrls().length > 0">

        <label for="file-upload" class="upload-label" *ngIf="previewUrls().length === 0">
          <div class="upload-icon">ðŸ“¸</div>
          <span>
            {{ editMode ? 'Add more photos or videos' : 'Click to upload photos or videos' }}
          </span>
        </label>

        <input id="file-upload" type="file" multiple (change)="onFileSelected($event)" hidden />

        <div class="media-grid" *ngIf="previewUrls().length > 0">

          <div class="media-item" *ngFor="let img of previewUrls(); let i = index">
            <img [src]="img" />
            <button type="button" class="remove-btn" (click)="removeImage(i)">
              âœ•
            </button>
          </div>

          <label for="file-upload" class="add-more-card">
            <span>+ Add</span>
          </label>

        </div>
      </div>

      <!-- =========================
           CONTENT SECTION
      ========================= -->

      <div class="section-divider"><span>Content</span></div>

      <div class="form-field">
        <label>Caption</label>
        <div class="input-wrapper">
          <textarea formControlName="caption" rows="3" placeholder="Write something catchy..."></textarea>
        </div>
      </div>

      <div class="form-field">
        <label>Hashtags</label>
        <div class="input-wrapper">
          <input
            type="text"
            #hashtagInput
            placeholder="Type hashtag and press space, enter or #"
            (keydown)="onHashtagKeydown($event, hashtagInput)"
            (blur)="onHashtagBlur(hashtagInput)" />
        </div>
        <div class="chips-wrap" *ngIf="hashtags().length">
          <button
            type="button"
            class="chip"
            *ngFor="let tag of hashtags()"
            (click)="removeHashtag(tag)">
            #{{ tag }} <span aria-hidden="true">âœ•</span>
          </button>
        </div>
      </div>

      <!-- =========================
           SETTINGS
      ========================= -->

      <div class="section-divider"><span>Settings</span></div>

      <div class="form-row">
        <div class="form-field flex-1">
          <label>Visibility</label>
          <div class="input-wrapper">
            <select formControlName="visibility">
              <option [value]="1">Public</option>
              <option [value]="2">Private</option>
            </select>
          </div>
        </div>

        <!-- Hide PostType in edit if you want (optional) -->
        <div class="form-field flex-1" *ngIf="!editMode">
          <label>Post Type</label>
          <div class="input-wrapper">
            <select formControlName="postType">
              <option [value]="1">Normal Post</option>
              <option [value]="2">Reel</option>
            </select>
          </div>
        </div>
      </div>

      <div class="checkbox-group grid-2">
        <label class="custom-checkbox">
          <input type="checkbox" formControlName="hideComments" />
          Hide Comments
        </label>

        <label class="custom-checkbox">
          <input type="checkbox" formControlName="hideLikes" />
          Hide Likes
        </label>

        <label class="custom-checkbox">
          <input type="checkbox" formControlName="hideShares" />
          Hide Shares
        </label>
      </div>

      <!-- =========================
           TAGGING & LOCATION
      ========================= -->

      <div class="section-divider optional">
        <span>Tagging & Location</span>
      </div>

      <div class="form-field">
        <label>Tag Users</label>
        <div class="input-wrapper">
          <input
            [value]="taggedUserQuery()"
            placeholder="Search users by name or username"
            (input)="onTaggedUserInput($any($event.target).value)"
            (blur)="onTaggedUserBlur()"
            (keydown)="onTaggedUserKeydown($event)" />
        </div>
        <div class="error-text" *ngIf="taggedUserError()">{{ taggedUserError() }}</div>
        <div class="chips-wrap" *ngIf="taggedUsers().length">
          <button
            type="button"
            class="chip"
            *ngFor="let user of taggedUsers()"
            (click)="removeTaggedUser(user._id)">
            @{{ user.userName || user.name }} <span aria-hidden="true">âœ•</span>
          </button>
        </div>
        <div class="suggestions-list" *ngIf="taggedUserQuery().trim().length >= 2 && userSuggestions().length">
          <button
            type="button"
            class="suggestion-item"
            *ngFor="let user of userSuggestions()"
            (click)="addTaggedUser(user)">
            <span class="suggestion-title">{{ user.name }}</span>
            <span class="suggestion-sub">@{{ user.userName }}</span>
          </button>
        </div>
      </div>

      <div class="form-field">
        <label>Location</label>
        <div class="input-wrapper">
          <input
            [value]="locationQuery()"
            placeholder="Search location"
            (input)="onLocationInput($any($event.target).value)" />
        </div>
        <div class="location-meta" *ngIf="selectedLocation()">
          <span class="location-coords">
            {{ selectedLocation()!.latitude | number:'1.4-6' }}, {{ selectedLocation()!.longitude | number:'1.4-6' }}
          </span>
          <button type="button" class="clear-link" (click)="clearLocation()">Clear</button>
        </div>
        <div class="suggestions-list" *ngIf="locationQuery().trim().length >= 2 && locationSuggestions().length">
          <button
            type="button"
            class="suggestion-item"
            *ngFor="let suggestion of locationSuggestions()"
            (click)="selectLocation(suggestion)">
            <span class="suggestion-title">{{ suggestion.displayName }}</span>
            <span class="suggestion-sub">
              {{ suggestion.latitude | number:'1.4-6' }}, {{ suggestion.longitude | number:'1.4-6' }}
            </span>
          </button>
        </div>
        <div class="helper-text" *ngIf="isLocationLoading()">Finding locations...</div>
      </div>

    </div>

    <!-- =========================
         FOOTER
    ========================= -->

    <div class="modal-footer">

      <button type="button" class="btn-secondary" (click)="close.emit()">
        Cancel
      </button>

      <button type="button" class="submit-btn" (click)="submit()" [disabled]="
  isUploading() ||
  isPosting() ||
  hasInvalidTaggedUserInput() ||
  !uploadedMedia().length ||
  (editMode && !hasChanges())
">

        <!-- Dynamic Button Text -->
        <span *ngIf="!isPosting() && !isUploading()">
          {{ editMode ? 'Update Post' : 'Share Post' }}
        </span>

        <span *ngIf="isUploading()">Uploading...</span>

        <span *ngIf="isPosting()">
          {{ editMode ? 'Updating...' : 'Sharing...' }}
        </span>

        <div class="small-spinner white" *ngIf="isPosting() || isUploading()"></div>

      </button>

    </div>

  </form>
</div>
